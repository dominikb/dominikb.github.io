{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-10-painless-ssh-setup-in-gitlab-ci/","result":{"data":{"site":{"siteMetadata":{"url":"https://dominikb.io","title":"Dominik Bauernfeind","labels":[{"tag":"laravel","tech":"Laravel","name":"DiLaravel","size":20,"color":"#ff2c1f"},{"tag":"php","tech":"PHP","name":"DiPhp","size":20,"color":"#8892bf"},{"tag":"gitlab","tech":"Gitlab","name":"FaGitlab","size":20,"color":"#fc6d25"},{"tag":"cicd","tech":"CI/CD","name":"DiTerminal","size":20,"color":null},{"tag":"ruby","tech":"Ruby","name":"DiRuby","size":20,"color":"#aa1401"},{"tag":"rails","tech":"Rails","name":"SiRubyonrails","size":20,"color":"#d30001"},{"tag":"java","tech":"Java","name":"FaJava","size":20,"color":"#df0000"},{"tag":"spring","tech":"Spring","name":"SiSpring","size":20,"color":"#6db33f"},{"tag":"spring-boot","tech":"Spring Boot","name":"SiSpringboot","size":20,"color":"#6db33f"}]}},"markdownRemark":{"html":"<p>Connecting to a different server from your CI job can be a hassle. Specifying the ssh connection parameters followed by the command to be executed can take quite a lot of space visually and cause all kinds of trouble with linebreaks if you want to space out your command over multiple lines.</p>\n<p>A better way is to create an ssh configuration on your Runner and simplify this especially if you need to connect to the target server multiple times.\nLet me show you my solution and how it came about.</p>\n<h2>Connecting to a remote server</h2>\n<p>First up, you need to make all parameters available inside the job, for example by using the Gitlab CI parameters.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1000px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b5b00beedce63ef1e02899befd94c5cc/e8649/gitlab-ci-variables.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACtElEQVR42mWSW08TQRTH99EP4ANQKI3RCiSUUrFSuQhtoUlJjInfRhOXN332C8gjkBhefCYxUV7QptykIbbS225t99Jtd3d2Z3fnODNSIniSX8/ZmTn/+Z/uComZe68WUonNlZXlN6mnT8TJqagYjoyK45ExMTweumYsHBJHQkPi8MiQODI6zAlRwuOjYvTh/c1IJPyanrkrLM2vw8LiC5hPPYe5x3mYTeQgHl+DiYlleBBdhCiF5cmpZ3RvHR7Nsf0sxGfXYDqWpmRgafklJFN5CIdjCeHLfqH/9eDUPzy8cI+OLvHBwSne/3yCi8VLfFT8hdka4+S4ikulJr64kHHpvMnr8/MGLhTK+Hvhp1c8rqB3b9/PCIahoyDAAEAI++n3DSK3ZKJqKtG6Gs0K0XSNPyuqQhSlw9faNNsI8R7gEXh7ex/jgizLyDQtsCyL+H4AqK+DqctgtKvQlcsc/QqjVYGOXAdVqkBPa4HV06gM5k4sy/a2t7fjQqvVQrZtA8YuoQEedgA7FgQY0UsxeLQmHq0Jq01wkQWea4Nr9//ukYA7RAh5Ozs7caHT6SDXdakg5oIYe9Cnjo1ej9cuBSEHAtrnM+gUDJuuMXzfvykoyxJyHOda0PM8Nj50u112iDWA6zLBANg+4TkAl/b49LLgtmCjISEmQMe+cohZDaZpchF2AZtgIMgyu8S0LZC034Bc56ZgqVSxFUVhjgJmnzaQQb56g5xBBBTfxaSuyuTDt0+kY+oBE6QmMBWcEarVGtZ1jTtiYRgGNJtNPjJzxv4OBnN6m3+Dmgh2d3fjwtnZD71cLruNRsNWVRVJkoRqtRqq1+ucQd1ut/+DvVDaw/oc+vn1tra2poVsNptYXV19kk6nkzQnc7lccmNjI5nP529AzyUzmQzPAwY9NLP+RCwWu/MHJVMu8dJbSYgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Variables configured in Gitlab CI\"\n        title=\"Variables configured in Gitlab CI\"\n        src=\"/static/b5b00beedce63ef1e02899befd94c5cc/00d43/gitlab-ci-variables.png\"\n        srcset=\"/static/b5b00beedce63ef1e02899befd94c5cc/63868/gitlab-ci-variables.png 250w,\n/static/b5b00beedce63ef1e02899befd94c5cc/0b533/gitlab-ci-variables.png 500w,\n/static/b5b00beedce63ef1e02899befd94c5cc/00d43/gitlab-ci-variables.png 1000w,\n/static/b5b00beedce63ef1e02899befd94c5cc/aa440/gitlab-ci-variables.png 1500w,\n/static/b5b00beedce63ef1e02899befd94c5cc/e8950/gitlab-ci-variables.png 2000w,\n/static/b5b00beedce63ef1e02899befd94c5cc/e8649/gitlab-ci-variables.png 2968w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>You can now connect to an external server using the provided credentials:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># .gitlab.ci.yml</span>\n\nDeploy:\n  script:\n    - <span class=\"token string\">\"ssh <span class=\"token variable\">${DEPLOY_SSH_SERVER}</span> -l <span class=\"token variable\">${DEPLOY_SSH_USER}</span> -p <span class=\"token variable\">${DEPLOY_SSH_PORT}</span> -i <span class=\"token variable\">${DEPLOY_SSH_PRIVATE_KEY}</span> 'ls -la <span class=\"token environment constant\">$HOME</span>'\"</span></code></pre></div>\n<p>But specifying those ssh parameters for every command is tedious. There is a better way.</p>\n<h2>Creating an ssh configuration</h2>\n<p>Running one-off commands using the parameterized ssh command is fine. Problems occurred for me when I needed to connect to multiple times or to multiple different servers.</p>\n<p>Always parameterizing the ssh command creates a lot of visual noise and makes it harder to understand what the given line is actually supposed to do.</p>\n<p>Try to scan this script and figure out what happens here:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">Deploy</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span> \n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"scp -P ${DEPLOY_SSH_PORT} -i ${DEPLOY_SSH_PRIVATE_KEY} -r artifacts ${DEPLOY_SSH_USER}@${DEPLOY_SSH_SERVER}:/opt/deploy_artifacts\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ssh -p ${DEPLOY_SSH_PORT} -i ${DEPLOY_SSH_PRIVATE_KEY} ${DEPLOY_SSH_USER}@${DEPLOY_SSH_SERVER} 'systemctl stop my-application'\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ssh -p ${DB_SSH_PORT} -i ${DB_SSH_PRIVATE_KEY} ${DB_SSH_USER}@${DB_SSH_SERVER} 'mysqldump --all-databases > backup.sql'\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ssh -p ${DEPLOY_SSH_PORT} -i ${DEPLOY_SSH_PRIVATE_KEY} ${DEPLOY_SSH_USER}@${DEPLOY_SSH_SERVER} 'systemctl start my-application'\"</span></code></pre></div>\n<p>Now again with a cleaner version where we separate configuration and workload:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">Deploy</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">before_script</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./ci/setup_ssh_configuration deploy_server ${DEPLOY_SSH_SERVER} ${DEPLOY_SSH_PORT} ${DEPLOY_SSH_USER} ${DEPLOY_SSH_PRIVATE_KEY}\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./ci/setup_ssh_configuration db_server ${DB_SSH_SERVER} ${DB_SSH_PORT} ${DB_SSH_USER} ${DB_SSH_PRIVATE_KEY}\"</span>\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"scp -r artifacts deploy_server:/opt/deploy_artifacts\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ssh deploy_server    'systemctl stop my-application'\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ssh db_server        'mysqldump --all-databases > backup.sql'\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ssh deploy_server    'systemctl start my-application'\"</span></code></pre></div>\n<p>By using a <code class=\"language-text\">before_script</code> we create a clear visual distinction between the configuration setup and the work that is actually done.</p>\n<p><strong>./ci/setup_ssh_configuration.sh</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n\n<span class=\"token builtin class-name\">set</span> -euo pipefail\n\n<span class=\"token function\">mkdir</span> -p ~/.ssh\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\"\nHost <span class=\"token variable\">${1}</span>\n    Target <span class=\"token variable\">${2}</span>\n    Port <span class=\"token variable\">${3}</span>\n    User <span class=\"token variable\">${4}</span>\n    IdentifyFile <span class=\"token variable\">${5}</span>\n<span class=\"token string\">\"\"</span>\" <span class=\"token operator\">>></span> <span class=\"token string\">\"~/.ssh/config\"</span></code></pre></div>\n<h3>Even shorter configuration</h3>\n<p>The <code class=\"language-text\">before_script</code> can be even shorter if we accept a naming convention for those SSH connection parameters:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># {PREFIX}_SSH_SERVER {PREFIX}_SSH_USER ...</span></code></pre></div>\n<p>With some edits in our <code class=\"language-text\">setup_ssh_configuration</code> script we can reduce the <code class=\"language-text\">yml</code> config to this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># .gitlab.ci.yml</span>\n\n<span class=\"token key atrule\">Deploy</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">before_script</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./ci/setup_ssh_configuration deploy_server DEPLOY\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"./ci/setup_ssh_configuration db_server DB\"</span>\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"scp -r artifacts deploy_server:/opt/deploy_artifacts\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ssh deploy_server    'systemctl stop my-application'\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ssh db_server        'mysqldump --all-databases > backup.sql'\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"ssh deploy_server    'systemctl start my-application'\"</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n<span class=\"token comment\"># ./ci/setup\\_ssh\\_configuration.sh</span>\n\n<span class=\"token builtin class-name\">set</span> -euo pipefail\n\n<span class=\"token function\">mkdir</span> -p ~/.ssh\n\n<span class=\"token assign-left variable\">target</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${2}</span>_SSH_HOST\"</span>\n<span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${2}</span>_SSH_PORT\"</span>\n<span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${2}</span>_SSH_USER\"</span>\n<span class=\"token assign-left variable\">keypath</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${2}</span>_SSH_PRIVATE_KEY\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\"\nHost <span class=\"token variable\">${1}</span>\n    Target <span class=\"token variable\">${<span class=\"token operator\">!</span>target}</span>\n    Port <span class=\"token variable\">${<span class=\"token operator\">!</span>port}</span>\n    User <span class=\"token variable\">${<span class=\"token operator\">!</span>user}</span>\n    IdentifyFile <span class=\"token variable\">${<span class=\"token operator\">!</span>keypath}</span>\n<span class=\"token string\">\"\"</span>\" <span class=\"token operator\">>></span> <span class=\"token string\">\"~/.ssh/config\"</span></code></pre></div>\n<h2>Reusing connections</h2>\n<p>One more improvement that can be made is to reuse the ssh connections.</p>\n<p>Depending on your CI-Setup you could have multiple scripts that connect to the same host within the same pipeline stage. Now, if your executed commands are all sub-second, the overhead of creating a new ssh session each time can be relatively large.</p>\n<p>You can improve upon this by once more extending the <code class=\"language-text\">setup_ssh_configuration.sh</code> to add the configuration for reusing previous TCP connections to the same host:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/usr/bin/env bash</span>\n<span class=\"token comment\"># ./ci/setup\\_ssh\\setup_ssh_configuration.sh</span>\n\n<span class=\"token builtin class-name\">set</span> -euo pipefail\n\n<span class=\"token function\">mkdir</span> -p ~/.ssh/sockets\n\n<span class=\"token assign-left variable\">target</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${2}</span>_SSH_HOST\"</span>\n<span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${2}</span>_SSH_PORT\"</span>\n<span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${2}</span>_SSH_USER\"</span>\n<span class=\"token assign-left variable\">keypath</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${2}</span>_SSH_PRIVATE_KEY\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\"\nHost <span class=\"token variable\">${1}</span>\n    Target <span class=\"token variable\">${<span class=\"token operator\">!</span>target}</span>\n    Port <span class=\"token variable\">${<span class=\"token operator\">!</span>port}</span>\n    User <span class=\"token variable\">${<span class=\"token operator\">!</span>user}</span>\n    IdentifyFile <span class=\"token variable\">${<span class=\"token operator\">!</span>keypath}</span>\n    ControlMaster auto\n    ControlPath ~/.ssh/sockets/%r@%h-%p\n    ControlPersist <span class=\"token number\">600</span>\n<span class=\"token string\">\"\"</span>\" <span class=\"token operator\">>></span> <span class=\"token string\">\"~/.ssh/config\"</span></code></pre></div>\n<p>Read more about reusing connections for ssh <a href=\"https://puppet.com/blog/speed-up-ssh-by-reusing-connections\">https://puppet.com/blog/speed-up-ssh-by-reusing-connections</a></p>","frontmatter":{"title":"Painless SSH Setup in Gitlab CI","date":"October 13, 2020","tags":["gitlab","cicd","shell","ssh"]}}},"pageContext":{"slug":"/2020-10-painless-ssh-setup-in-gitlab-ci/"}},"staticQueryHashes":["2212750296","2457483284","3019618709","63159454"]}